Залежність (Dependency) ін'єкція (Injection) (DI) - це дизайн-принцип та патерн програмування, який використовується для зменшення залежностей між компонентами програми та полегшення тестування та обслуговування коду. Основна ідея DI полягає в тому, щоб не створювати об'єкти інших класів в середині класу, де вони потрібні, а замість цього вставляти (ін'єктувати) ці залежності ззовні. 

Основні поняття в DI:

1. **Залежність (Dependency)**: Це об'єкт або сервіс, який клас використовує для виконання своєї роботи. Наприклад, якщо клас `UserService` потребує доступ до бази даних, то база даних є його залежністю.

2. **Ін'єкція (Injection)**: Це процес передачі залежностей в клас через конструктор, метод або інші засоби. Ін'єкція може бути проведена вручну або за допомогою контейнера ін'єкції залежностей (DI container).

3. **DI Container (Контейнер ін'єкції залежностей)**: Це інструмент або бібліотека, яка допомагає автоматизувати процес ін'єкції залежностей. Контейнер може створювати та управляти об'єктами та їх залежностями та дозволяє легко змінювати конфігурацію програми.

Переваги Dependency Injection включають:

- Покращена читабельність коду, оскільки залежності вказуються явно.
- Зручність у внесенні змін у конфігурацію програми, оскільки залежності можна змінювати без зміни самого коду.
-  Простіше тестувати код, оскільки можна легко замінити реальні залежності на тестові (mock або stub) під час тестування.

Один із  прикладів DI - це ін'єкція залежностей через конструктор класу. Наприклад, ви можете передати залежність (наприклад, сервіс бази даних) у конструктор класу `UserService`, і він буде використовувати цю залежність для виконання своєї роботи.

```python
class UserService:
    def __init__(self, database: Database):
        self.database = database

    def get_user(self, user_id):
        return self.database.query(user_id)
```

Це дозволяє легко замінити реальну базу даних на іншу або на підроблену базу даних (mock) для тестування або зміни конфігурації.


##  DI в  FastAPI
Dependency Injection (DI) також грає важливу роль в контексті FastAPI. FastAPI рекомендує використовувати DI для керування залежностями та вставки їх у шляхи (endpoints) та функції обробників.

Ось приклад використання DI в FastAPI:

```python
from fastapi import FastAPI, Depends

app = FastAPI()

# Залежність, яка використовується в кількох місцях
def get_db_connection():
    db_connection = "Your DB Connection"
    # Можна тут ініціалізувати та повернути реальне підключення до бази даних
    return db_connection

# Використовуємо залежність у шляху (endpoint)
@app.get("/items/")
async def read_items(db: str = Depends(get_db_connection)):
    # Використовуємо db (залежність) у функції обробників
    return {"db_connection": db}

# Ще один шлях, який також використовує залежність
@app.get("/users/")
async def read_users(db: str = Depends(get_db_connection)):
    return {"db_connection": db}
```

У цьому прикладі ми створили залежність `get_db_connection`, яка представляє з'єднання з базою даних (це може бути реальне підключення). Ми передаємо цю залежність у шляхи `/items/` та `/users/`, вказуючи аргумент `db` у функціях обробників. FastAPI автоматично вирішує, як вставити цю залежність у функції обробників.


## Depends
Розглянемо детальніше, як саме працює `Depends` в FastAPI:

1. **Визначення Залежностей**: Ви визначаєте функції, які представляють ваші залежності. Ці функції повинні повертати значення, які ви хочете вставити у ваші функції обробників.

```python
from fastapi import Depends

def get_db_connection():
    db_connection = "Your DB Connection"
    # Можна тут ініціалізувати та повернути реальне підключення до бази даних
    return db_connection
```

2. **Використання Залежностей у Шляхах**: Ви можете використовувати залежності у ваших шляхах (endpoints) або функціях обробників, передаючи їх як аргументи у вигляді параметра `Depends`. Ви можете вставити одну або декілька залежностей у функцію обробник, і FastAPI автоматично надає їх під час виклику.

```python
from fastapi import FastAPI, Depends

app = FastAPI()

# Вставляємо залежність "db" у функцію обробник "read_items"
@app.get("/items/")
async def read_items(db: str = Depends(get_db_connection)):
    return {"db_connection": db}
```

3. **Автоматична Вставка Залежностей**: Під час виклику шляху, FastAPI автоматично визначає, які залежності потрібно вставити у функцію обробник. В нашому прикладі, функція обробник `read_items` очікує аргумент `db`, і FastAPI автоматично вставляє значення, отримане з функції `get_db_connection`.

4. **Задачі Залежностей**: Залежності також можуть мати власні задачі. Наприклад, ви можете використовувати `Depends` для автентифікації користувача або перевірки доступу до ресурсу перед виконанням функції обробник.

```python
from fastapi import FastAPI, Depends

app = FastAPI()

# Визначення функції для отримання користувача з токеном аутентифікації
def get_current_user(token: str = Depends(get_token)):
    # Отримання користувача на основі токену
    user = authenticate_user(token)
    if user is None:
        raise HTTPException(status_code=401, detail="Unauthorized")
    return user

@app.get("/secure-data/")
async def get_secure_data(current_user: User = Depends(get_current_user)):
    # Використання залежності "current_user" для автентифікації користувача
    return {"user_id": current_user.id, "data": "Secure Data"}
```

Отже, `Depends` в FastAPI допомагає керувати залежностями та автоматично вставляти їх у ваші функції обробників, роблячи код більш читабельним та покращуючи керованість залежностями в вашому веб-додатку.